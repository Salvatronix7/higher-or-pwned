name: Comment preview URL

on:
  workflow_run:
    workflows: ["Deploy preview to GitHub Pages"]
    types:
      - completed

permissions:
  contents: read
  pull-requests: write

jobs:
  comment:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Find PR number
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const [pr] = context.payload.workflow_run.pull_requests;
            core.setOutput('number', pr ? pr.number : '');

      - name: Comment with preview
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number('${{ steps.pr.outputs.number }}');
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/`;
            const body = `âœ… Preview de GitHub Pages disponible: ${pagesUrl}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body
            });
